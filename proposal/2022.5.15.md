导师您好！我是刘俊余，GitHub: `iyear`

以下是我对 `一种基于 gRPC 的轻量级应用间双向通信框架` 项目的一些初步思考。

## 背景

在朋友的推荐下了解到OSAPP，浏览了一下一些项目，发现了 `Go Plugin over gRPC	` ，我对此非常感兴趣。

在之前，我也遇到了和项目描述中一样的问题，`Go` 原生 `Plugin` 实现的问题很多，限制非常大，其实并不适合作为插件机制来使用。在我的 `pure-live` 项目起步时，我对此做过一番调研，最好还是选择抛弃，因为它严重阻碍了跨平台特性。

如今 `pure-live` 依旧以代码耦合的形式维护着不同平台的直播流、弹幕协议具体实现。如果完成这个项目后，将解决以下痛点：

- 无法单独管理不同平台的维护周期，牵一发而动全身。插件机制下项目的扩展性、健壮性、灵活性将大大提高。
- 无法跨主机部署调用，尽管在 `pure-live` 中是不必要的，但对于大型项目应当是可选项。
- 无法跨语言维护，而 `gRPC` 允许不同语言的开发者共同参与到平台实现维护中。
- 插件的代码编写失误导致核心程序出现崩溃。
- ……

## 对已有开源实现的选型评估

在了解项目需求之后，本着不重复造轮子的原则，我先寻找是否有现存的开源实现。

`hashicorp` 早在 2012-2013 年，就开始考虑为 `Go` 实现插件机制，远早于 `plugin` 包发布时间(2017) ，可见 `go-plugin` 项目一开始并不是为了解决 `plugin` 问题而诞生的，但这并不影响其对这些问题的解决。

其 `GitHub` 仓库为: https://github.com/hashicorp/go-plugin，经过了4年多的生产环境验证，已用于许多著名开源项目。

如此优秀的项目，是否可以直接用于这次的 `OSAPP` ？我的答案是否定的，在粗略阅读其源码以及翻看历史 `commits` 后，以下是我认为 `go-plugin` 存在的一些问题。

#### 代码实现历史包袱较重

其支持 `net/rpc` 与 `gRPC` 两种协议。`gRPC` 为

初步阅读源码时，就能感受到其历史包袱之重，有关 `gRPC` 的实现与字段比较生硬地嵌在各种接口与结构体中。

由于项目从2016年1月开始维护，2017年六月开始加入 `gRPC` 支持，导致源码中使用了大量的接口为 `net/rpc` 的最初实现做向下兼容，阅读困难也很大。

#### 只支持本机插件系统、跨平台实现难度大

`go-plugin` 以 `exec.Command` 的方式启动插件，以 `process id` 检查插件是否存活。这就完全无法将插件系统在云原生的架构上组织。

而 `pid` 这种强依赖操作系统的实现也一定程度上增加了跨平台难度。

#### 日志系统可扩展性差

由于只支持本机系统，其日志收集采用 `stdout/stderr` 的方式直接 `copy` 到宿主进程。`stdout/stderr` 的灵活性相比网络传输较差，更难以做多主机的迁移。


## 我的初步方案

不同项目对插件具体启动等等有自己的取舍，我们应当只关注**通信**与**通信管理**，并为外部保留好接口即可。我们做最小实现，为未来的扩展做好预留。

先针对 `go-plugin` 现存在的问题进行阐述，我的解决方案为：

#### 采用 `gRPC` 为唯一支持协议

`net/rpc` 不支持跨语言，兼容性较差。同时在维护力度、性能方面与 `gRPC` 差距较大。 `go-plugin` 也推荐使用 `gRPC` 实现。

所以我考虑直接抛弃代码层面的协议兼容性，采用 `gRPC` 为唯一支持协议，也简化了具体实现。`gRPC` 自带了 `TLS` `Metadata` 等等组件，无需再对底层做自己粗糙的对接。

序列化采用 `ProtoBuf` 。

#### 改变原有 `C/S` 关系

反转 `go-plugin` 的 `C/S` 关系，改为宿主 `Server` ，插件 `Client` 。使用双向流式 RPC，宿主与插件在运行期间保持连接。

项目不负责插件启动，只对外暴露 `Bind` 服务，由插件主动向宿主请求绑定自身。宿主可以通过白名单、Token等方式对插件合法性做校验。

#### 网络层面的健康检查机制与日志系统

直接利用 `gRPC` 作为健康检查底层，同时为上层应用留出健康检查各种情况的钩子。

日志也考虑通过网络向宿主传输，由宿主统一管理并输出。

但日志量较大情况下向宿主是否会影响性能这点还有待考虑，且需要实现后的 `Benchmark`。如果影响较大考虑实现一个自带插件/进程，专用于日志收集和输出。

### 取消PluginSet，插件单一职责化


虽然提到 `go-plugin` 一些因历史包袱留下的我认为可优化的问题，其设计思想依旧十分优秀，所以项目主要设计理念依旧会参考 `go-plugin` ，并尝试做出一些改进。

## 最后

了解到OSAPP比较迟，前几天才开始看项目比较匆忙，也鉴于自身水平有限，一些不精确的地方和更加细致具体的方案还需在之后与您深入研讨。接下来几天我会着重研究 `go-plugin` 对 `gRPC` 的实现，逐渐产出更加细致的方案。

感谢您花费时间阅读我的一些想法，十分期待中选后与您的交流学习！